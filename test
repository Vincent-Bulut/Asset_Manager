
from airflow import DAG
from airflow.providers.http.operators.http import SimpleHttpOperator
from airflow.utils.dates import days_ago
import json

# Définition du DAG
dag = DAG(
    'dynamic_date_fastapi_call',
    default_args={'owner': 'airflow'},
    schedule_interval=None,  # Exécution manuelle
    start_date=days_ago(1),
    catchup=False
)

# Task pour appeler l'API avec la date du jour comme path parameter
call_api_task = SimpleHttpOperator(
    task_id='call_api_post',
    http_conn_id='my_api_connection',  # Connexion HTTP
    endpoint='/process/{{ ds }}',  # Injection de la date via Jinja
    method='POST',
    data=json.dumps({"key": "value"}),  # Payload JSON
    headers={"Content-Type": "application/json"},
    response_filter=lambda response: response.json(),  # Transformation de la réponse
    log_response=True,
    dag=dag
)

# Lancer la tâche
call_api_task