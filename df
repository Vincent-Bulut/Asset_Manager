
from datetime import date

# Obtenir la date actuelle sous forme de chaîne
today = date.today().strftime('%Y-%m-%d')

# Requête avec filtre sur les traders "en vie"
result = (self.session.query(
    BusinessManager,
    Traders,
    Users,
    Entity,
    TraderAllocation,
    Structure
)
.join(
    Traders, Traders.ut_bm == BusinessManager.ut
)
.join(
    Users, Users.ut == BusinessManager.ut
)
.join(
    Entity, Entity.entity_code == Traders.entity_code
)
.join(
    TraderAllocation, TraderAllocation.id_trd == Traders.id_trader
)
.join(
    Structure, Structure.id_structure == TraderAllocation.id_struct
)
.filter(
    BusinessManager.ut == business_manager_ut,
    Traders.ut.in_(
        self.session.query(Users.ut)
        .join(Traders, Traders.ut == Users.ut)
        .filter(
            Users.disabled == False,
            (Traders.end_date == None) | (Traders.end_date > today)  # Filtrer les traders actifs
        )
    )
)
.all())