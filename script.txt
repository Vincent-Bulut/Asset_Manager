
from sqlalchemy.orm import Session
from sqlalchemy import select
from datetime import datetime

def get_active_trader_allocations(session: Session):
    today = datetime.utcnow().strftime("%Y-%m-%d")  # Convertir la date actuelle en string "YYYY-MM-DD"

    # Requête pour récupérer les TraderAllocations avec une structure non expirée
    stmt = (
        select(TraderAllocation)
        .join(Structure, TraderAllocation.id_struct == Structure._id_structure)
        .where(Structure.end_date > today)  # Comparaison directe de strings
    )

    # Exécuter la requête
    result = session.execute(stmt).scalars().all()
    
    return result  # Retourne la liste des objets TraderAllocation

# Exemple d'utilisation
session = Session()
active_allocations = get_active_trader_allocations(session)

for allocation in active_allocations:
    print(f"Trader {allocation._id_trd} - Structure {allocation.id_struct}")