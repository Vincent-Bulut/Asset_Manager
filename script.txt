
from sqlalchemy.orm import sessionmaker

Session = sessionmaker(bind=engine)

def update_trd_time(req: TraderTimeModel):
    ts = utils.get_current_timestamp()
    session = Session()
    try:
        # Select rows for update and lock them
        trd_times = session.query(TraderTimes).filter(
            TraderTimes.id_trader == req.id_trader,
            TraderTimes.id_structure == req.id_structure,
            TraderTimes.time_month == req.time_month,
            TraderTimes.time_year == req.time_year
        ).with_for_update().all()

        for trd_time in trd_times:
            trd_time.time_value = req.time_value
            trd_time.timestamp = ts
        
        session.commit()
    except Exception as e:
        session.rollback()
        raise e
    finally:
        session.close()