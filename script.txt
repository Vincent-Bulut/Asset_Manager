

from sqlalchemy.orm import Session
from sqlalchemy import select

def duplicate_traders_to_new_structure(session: Session, old_struct_id: int, new_struct_id: int):
    try:
        # Récupérer les traders liés à l'ancienne structure
        traders = session.execute(
            select(TraderAllocation._id_trd).where(TraderAllocation.id_struct == old_struct_id)
        ).scalars().all()

        # Créer une nouvelle ligne pour chaque trader avec le nouvel id_struct
        new_allocations = [
            TraderAllocation(_id_trd=trader_id, id_struct=new_struct_id) for trader_id in traders
        ]

        # Ajouter toutes les nouvelles lignes en une seule transaction
        session.add_all(new_allocations)
        session.commit()

        print(f"Ajouté {len(new_allocations)} traders à la nouvelle structure {new_struct_id}")

    except Exception as e:
        session.rollback()
        print(f"Erreur lors de l'ajout des traders : {e}")