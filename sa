
from airflow import DAG
from airflow.operators.python import PythonOperator
from datetime import datetime, timedelta
import requests

# Définition des paramètres de l'API
API_URL = "https://api.example.com/destinataires"

# Fonction pour récupérer la liste des destinataires depuis l'API
def get_recipients(**kwargs):
    response = requests.get(API_URL)
    if response.status_code == 200:
        recipients = response.json()  # Supposons que l'API renvoie un JSON sous forme de liste
        kwargs['ti'].xcom_push(key='recipients', value=recipients)  # Stocker la liste dans XCom
    else:
        raise Exception("Erreur lors de la récupération des destinataires")

# Fonction personnalisée exploitant la liste des destinataires
def process_recipients(**kwargs):
    ti = kwargs['ti']
    recipients = ti.xcom_pull(task_ids='get_recipients', key='recipients')

    if not recipients:
        raise ValueError("Liste des destinataires vide ou non récupérée")

    # Exécuter un traitement personnalisé sur chaque destinataire
    for recipient in recipients:
        print(f"Traitement pour {recipient}")  # Remplacez cette ligne par votre logique métier

# Définition du DAG
default_args = {
    'owner': 'airflow',
    'depends_on_past': False,
    'start_date': datetime(2024, 1, 1),
    'retries': 1,
    'retry_delay': timedelta(minutes=5),
}

dag = DAG(
    'api_to_python_script',
    default_args=default_args,
    description='DAG récupérant une liste de destinataires via API et exécutant un script Python',
    schedule_interval=timedelta(days=1),
)

# Tâche 1 : Récupération des destinataires via API GET
get_recipients_task = PythonOperator(
    task_id='get_recipients',
    python_callable=get_recipients,
    provide_context=True,
    dag=dag,
)

# Tâche 2 : Exécuter le script personnalisé avec la liste récupérée
process_recipients_task = PythonOperator(
    task_id='process_recipients',
    python_callable=process_recipients,
    provide_context=True,
    dag=dag,
)

# Définition de la séquence d'exécution
get_recipients_task >> process_recipients_task